name: Build and Package

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.4.0

      - name: Run build in Debian 12 container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace debian:12-slim bash -c \
          "mkdir -p /workspace/output && sed -i 's/sudo //g' /workspace/build.sh && chmod +x /workspace/build.sh && /workspace/build.sh && rm -rf /workspace/output/*-dbgsym*"

      - name: Collect build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            /home/runner/work/ta-lib-debian/ta-lib-debian/output/*

      - name: Determine the release title
        id: release_title
        run: |
          FIRST_DEB=$(ls /home/runner/work/ta-lib-debian/ta-lib-debian/output/*.deb | sort | head -n 1)
          FIRST_DEB_NAME=$(basename $FIRST_DEB)
          echo "RELEASE_TITLE=${FIRST_DEB_NAME%.*}" >> $GITHUB_ENV

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.RELEASE_TITLE }}
          release_name: ${{ env.RELEASE_TITLE }}
          draft: false
          prerelease: true

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: /home/runner/work/ta-lib-debian/ta-lib-debian/output/*.deb
          asset_name: ${{ env.RELEASE_TITLE }}.deb
          asset_content_type: application/vnd.debian.binary-package
